@page
@model SettingsModel
@{
    ViewData["Title"] = "Settings";
}

<div class="settings-container">
    <div class="settings-card">
        <div class="card-header">
            <h2>Settings</h2>
        </div>
        
        <div class="card-body">
            <!-- Model Management Section -->
            <div class="settings-section">
                <div class="section-header">
                    <h3>Configured Models</h3>
                    <div class="section-header-actions">
                        <button type="button" class="btn btn-secondary" onclick="exportModels()" title="Export all model configurations">
                            Export Config
                        </button>
                        <button type="button" class="btn btn-secondary" onclick="importModels()" title="Import model configurations">
                            Import Config
                        </button>
                        <button type="button" class="btn btn-primary" onclick="openModelFlyout()">
                           Add Model
                        </button>
                    </div>
                </div>
                <input type="file" id="importFileInput" accept=".modelconfig" style="display: none;" onchange="handleImportFile(event)" />
                
                @if (Model.ConfiguredModels.Any())
                {
                    <div class="models-table-container">
                        <table class="models-table">
                            <thead>
                                <tr>
                                    <th>Model Name</th>
                                    <th>Endpoint</th>
                                    <th>API Key</th>
                                    <th>Type</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var mdl in Model.ConfiguredModels)
                                {
                                    <tr data-model-id="@mdl.Id" data-original-name="@mdl.ModelName" data-original-endpoint="@mdl.Endpoint">
                                        <td class="model-name">
                                            <input type="text" 
                                                   class="editable-input name-input" 
                                                   value="@mdl.ModelName"
                                                   data-field="name"
                                                   onchange="markRowChanged(this)" />
                                        </td>
                                        <td class="model-endpoint">
                                            <input type="text" 
                                                   class="editable-input endpoint-input" 
                                                   value="@mdl.Endpoint"
                                                   data-field="endpoint"
                                                   onchange="markRowChanged(this)" />
                                        </td>
                                        <td class="model-apikey">
                                            <input type="password" 
                                                   class="editable-input apikey-input" 
                                                   data-model-name="@mdl.ModelName"
                                                   value="@(Model.GetMaskedApiKey(mdl.ModelName))"
                                                   data-field="apikey"
                                                   placeholder="Enter API key..."
                                                   onchange="markRowChanged(this)" />
                                            <button type="button" class="btn-icon" onclick="toggleApiKeyVisibility(this)">üëÅ</button>
                                        </td>
                                        <td class="model-type" data-provider="@mdl.Provider.ToDisplayString()">
                                            <span class="badge badge-@mdl.Provider.ToDisplayString().ToLower()">
                                                @mdl.Provider.ToDisplayString()
                                            </span>
                                        </td>
                                        <td class="model-actions">
                                            <button type="button" class="btn-icon btn-save" onclick="saveRow(this)" disabled title="Save changes">
                                                üíæ
                                            </button>
                                            <button type="button" class="btn-icon btn-delete" onclick="deleteModel(@mdl.Id, '@mdl.ModelName')" title="Delete model">
                                                üóëÔ∏è
                                            </button>
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                }
                else
                {
                    <div class="empty-state">
                        <p>No models configured. Click "Add Model" to get started.</p>
                    </div>
                }
            </div>
            
            @if (!string.IsNullOrEmpty(Model.StatusMessage))
            {
                <div class="alert @(Model.IsSuccess ? "alert-success" : "alert-error")">
                    @Model.StatusMessage
                </div>
            }
            
            <div class="form-actions">
                <button type="button" class="btn btn-secondary" onclick="window.location.href='/'">Back to Home</button>
            </div>
        </div>
    </div>
    
    @* <div class="info-card">
        <h3>‚ÑπÔ∏è About Model Configuration</h3>
        <ul>
            <li>Configure multiple AI models with their endpoints and API keys.</li>
            <li>API keys are stored <strong>in memory only</strong> during runtime for security.</li>
            <li>OpenAI models use the standard OpenAI API format.</li>
            <li>Azure models use Azure OpenAI or Azure AI Foundry endpoints.</li>
            <li>Models configured here will appear in the model dropdown on the main page.</li>
        </ul>
    </div> *@
</div>

<!-- Import Confirmation Modal -->
<div id="importConfirmModal" class="modal hidden">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Import Model Configuration</h3>
            <button type="button" class="modal-close" onclick="closeImportConfirmModal()">&times;</button>
        </div>
        <div class="modal-body">
            <div class="file-select-section">
                <label class="file-select-label">Select Configuration File:</label>
                <div class="file-select-display">
                    <span id="importSelectedFileName" class="selected-file-name">No file selected</span>
                    <button type="button" class="btn btn-secondary" onclick="selectImportFile()">Choose File</button>
                </div>
            </div>
            <div class="import-warning">
                <strong>‚ö†Ô∏è Warning: <br />This operation will:</strong>
                <ul>
                    <li>Update existing models with matching names</li>
                    <li>Add new models from the file</li>
                    <li>Delete models not present in the file</li>
                </ul>
            </div>
        </div>
        <div class="modal-footer">
            @* <button type="button" class="btn btn-secondary" onclick="closeImportConfirmModal()">Cancel</button> *@
            <button type="button" id="btnConfirmImport" class="btn btn-primary" onclick="confirmImport()" disabled>Import Models</button>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div id="deleteConfirmModal" class="modal hidden">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Confirm Delete</h3>
            <button type="button" class="modal-close" onclick="closeDeleteConfirmModal()">&times;</button>
        </div>
        <div class="modal-body">
            <p class="delete-confirm-text">Are you sure you want to delete the model:</p>
            <p class="delete-model-name" id="deleteModelName"></p>
            <p class="delete-warning">This action cannot be undone.</p>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary" onclick="closeDeleteConfirmModal()">Cancel</button>
            <button type="button" class="btn btn-danger" onclick="confirmDelete()">Delete Model</button>
        </div>
    </div>
</div>

<!-- Import Progress Overlay -->
<div id="importProgressOverlay" class="progress-overlay hidden">
    <div class="progress-content">
        <div class="spinner"></div>
        <p class="progress-message">Importing models...</p>
        <p class="progress-submessage">Please wait</p>
    </div>
</div>

<!-- Model Configuration Flyout -->
<div id="modelFlyout" class="flyout">
    <div class="flyout-content">
        <div class="flyout-header">
            <h3 id="flyoutTitle">Add Model</h3>
            <button type="button" class="flyout-close" onclick="closeModelFlyout()">&times;</button>
        </div>
        <div class="flyout-body">
            <input type="hidden" id="editModelId" />
            
            <div class="form-group">
                <label for="modelName">Model Name *</label>
                <input type="text" 
                       id="modelName" 
                       class="form-control" 
                       placeholder="e.g., gpt-4, DeepSeek-V3"
                       maxlength="100" />
                <small class="form-text">Unique identifier for this model</small>
            </div>
            
            <div class="form-group">
                <label for="modelEndpoint">Endpoint URL *</label>
                <input type="text" 
                       id="modelEndpoint" 
                       class="form-control" 
                       placeholder="e.g., https://api.openai.com/v1/"
                       maxlength="500" />
                <small class="form-text">The API endpoint for this model</small>
            </div>
            
            <div class="form-group">
                <label for="modelApiKey">API Key</label>
                <div class="api-key-input-group">
                    <input type="password" 
                           id="modelApiKey" 
                           class="form-control" 
                           placeholder="Enter API key (optional)" />
                    <button type="button" class="btn btn-secondary btn-toggle-visibility" onclick="toggleVisibility('modelApiKey')">
                        üëÅ
                    </button>
                </div>
                <small class="form-text">API key can be set now or later</small>
            </div>
            
            <div class="form-group">
                <label for="modelProvider">Provider *</label>
                <select id="modelProvider" class="form-control">
                    <option value="OpenAI">OpenAI</option>
                    <option value="Azure">Azure</option>
                    <option value="xAI">xAI</option>
                    <option value="Google" disabled>Google (Coming Soon)</option>
                    <option value="Anthropic" disabled>Anthropic (Coming Soon)</option>
                </select>
                <small class="form-text">Select the AI provider for this model</small>
            </div>
            
            <div id="flyoutError" class="alert alert-error" style="display: none;"></div>
        </div>
        <div class="flyout-footer">
            <button type="button" class="btn btn-primary" onclick="saveModel()">Save</button>
        </div>
    </div>
</div>

@section Scripts {
<script>
        function toggleVisibility(inputId) {
            const input = document.getElementById(inputId);
            if (input.type === 'password') {
                input.type = 'text';
            } else {
                input.type = 'password';
            }
        }

        function toggleApiKeyVisibility(btn) {
            const input = btn.previousElementSibling;
            if (input.type === 'password') {
                input.type = 'text';
            } else {
                input.type = 'password';
            }
        }

        function markRowChanged(input) {
            const row = input.closest('tr');
            const saveBtn = row.querySelector('.btn-save');
            if (saveBtn) {
                saveBtn.disabled = false;
                saveBtn.style.opacity = '1';
            }
            
            // Mark API key input as changed if it's the API key field
            if (input.classList.contains('apikey-input')) {
                input.dataset.changed = 'true';
            }
        }

        async function saveRow(btn) {
            const row = btn.closest('tr');
            const id = row.dataset.modelId;
            const nameInput = row.querySelector('.name-input');
            const endpointInput = row.querySelector('.endpoint-input');
            const apikeyInput = row.querySelector('.apikey-input');
            
            const modelName = nameInput.value.trim();
            const endpoint = endpointInput.value.trim();
            const apiKey = apikeyInput.value.trim();
            
            if (!modelName || !endpoint) {
                alert('Model name and endpoint are required.');
                return;
            }

            // Only send API key if it was actually changed by the user
            const apiKeyChanged = apikeyInput.dataset.changed === 'true';
            const isMasked = apiKey.includes('...') || apiKey.includes('‚Ä¢‚Ä¢');
            
            // Determine what to send:
            // - If user changed the API key AND it's not masked, send the new key
            // - If user didn't change it (still masked), don't send anything (undefined)
            // - If user cleared it, send null
            let apiKeyToSend;
            if (apiKeyChanged) {
                if (isMasked) {
                    // This shouldn't happen, but just in case
                    apiKeyToSend = undefined;
                } else if (apiKey === '') {
                    apiKeyToSend = null;  // User cleared the field
                } else {
                    apiKeyToSend = apiKey;  // User entered a new key
                }
            } else {
                // Not changed, don't include in request
                apiKeyToSend = undefined;
            }
            
            // Get provider from the row's data attribute
            const providerCell = row.querySelector('.model-type');
            const provider = providerCell ? providerCell.dataset.provider : 'OpenAI';
            
            const requestBody = {
                modelName: modelName,
                endpoint: endpoint,
                provider: provider
            };
            
            // Only include apiKey if it's defined
            if (apiKeyToSend !== undefined) {
                requestBody.apiKey = apiKeyToSend;
            }
            
            try {
                const response = await fetch(`/api/models/${id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(requestBody)
                });

                if (response.ok) {
                    // Update original values
                    row.dataset.originalName = modelName;
                    row.dataset.originalEndpoint = endpoint;
                    apikeyInput.dataset.modelName = modelName;
                    apikeyInput.dataset.changed = 'false';  // Reset the changed flag
                    
                    // Disable save button
                    btn.disabled = true;
                    btn.style.opacity = '0.5';
                    
                    // Show success feedback
                    btn.textContent = '‚úì';
                    setTimeout(() => {
                        btn.textContent = 'üíæ';
                    }, 1000);
                } else {
                    const error = await response.json();
                    alert(error.error || 'Failed to save changes.');
                }
            } catch (error) {
                alert('An error occurred: ' + error.message);
            }
        }

        function openModelFlyout() {
            document.getElementById('flyoutTitle').textContent = 'Add Model';
            document.getElementById('editModelId').value = '';
            document.getElementById('modelName').value = '';
            document.getElementById('modelEndpoint').value = '';
            document.getElementById('modelApiKey').value = '';
            document.getElementById('modelProvider').value = 'OpenAI';
            document.getElementById('flyoutError').style.display = 'none';
            document.getElementById('modelFlyout').classList.add('active');
        }

        function closeModelFlyout() {
            document.getElementById('modelFlyout').classList.remove('active');
        }

        async function saveModel() {
            const id = document.getElementById('editModelId').value;
            const modelName = document.getElementById('modelName').value.trim();
            const endpoint = document.getElementById('modelEndpoint').value.trim();
            const apiKey = document.getElementById('modelApiKey').value.trim();
            const provider = document.getElementById('modelProvider').value;
            const errorDiv = document.getElementById('flyoutError');

            if (!modelName || !endpoint) {
                errorDiv.textContent = 'Model name and endpoint are required.';
                errorDiv.style.display = 'block';
                return;
            }

            try {
                const url = id ? `/api/models/${id}` : '/api/models';
                const method = id ? 'PUT' : 'POST';
                
                const response = await fetch(url, {
                    method: method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        modelName: modelName,
                        endpoint: endpoint,
                        apiKey: apiKey || null,
                        provider: provider
                    })
                });

                if (response.ok) {
                    window.location.reload();
                } else {
                    const error = await response.json();
                    errorDiv.textContent = error.error || 'Failed to save model.';
                    errorDiv.style.display = 'block';
                }
            } catch (error) {
                errorDiv.textContent = 'An error occurred: ' + error.message;
                errorDiv.style.display = 'block';
            }
        }

        // Store pending delete operation
        let pendingDeleteId = null;
        let pendingDeleteName = null;

        async function deleteModel(id, modelName) {
            // Store delete info and show confirmation modal
            pendingDeleteId = id;
            pendingDeleteName = modelName;
            showDeleteConfirmModal(modelName);
        }

        // Show delete confirmation modal
        function showDeleteConfirmModal(modelName) {
            document.getElementById('deleteModelName').textContent = modelName;
            document.getElementById('deleteConfirmModal').classList.remove('hidden');
        }

        // Close delete confirmation modal
        function closeDeleteConfirmModal() {
            document.getElementById('deleteConfirmModal').classList.add('hidden');
            pendingDeleteId = null;
            pendingDeleteName = null;
        }

        // Confirm and proceed with delete
        async function confirmDelete() {
            if (!pendingDeleteId) {
                return;
            }

            const id = pendingDeleteId;
            const modelName = pendingDeleteName; // Store before closing modal
            closeDeleteConfirmModal();

            try {
                const response = await fetch(`/api/models/${id}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    showToast(`Model "${modelName}" deleted successfully`, 'success');
                    setTimeout(() => window.location.reload(), 1000);
                } else {
                    showToast('Failed to delete model', 'error');
                }
            } catch (error) {
                showToast('An error occurred: ' + error.message, 'error');
            }
        }

        // Export model configurations
        async function exportModels() {
            try {
                window.location.href = '/Settings?handler=Export';
            } catch (error) {
                alert('Export failed: ' + error.message);
            }
        }

        // Open import modal directly
        function importModels() {
            // Reset file input and show modal
            document.getElementById('importFileInput').value = '';
            document.getElementById('importSelectedFileName').textContent = 'No file selected';
            document.getElementById('btnConfirmImport').disabled = true;
            document.getElementById('importConfirmModal').classList.remove('hidden');
        }

        // Trigger file picker from modal
        function selectImportFile() {
            document.getElementById('importFileInput').click();
        }

        // Store the selected file for later use
        let pendingImportFile = null;

        // Handle the imported file
        async function handleImportFile(event) {
            const file = event.target.files[0];
            if (!file) {
                return;
            }

            // Verify file extension
            if (!file.name.endsWith('.modelconfig')) {
                showToast('Invalid file type. Please select a .modelconfig file.', 'error');
                event.target.value = ''; // Reset input
                document.getElementById('importSelectedFileName').textContent = 'No file selected';
                document.getElementById('btnConfirmImport').disabled = true;
                return;
            }

            // Store the file and update UI
            pendingImportFile = file;
            document.getElementById('importSelectedFileName').textContent = file.name;
            document.getElementById('btnConfirmImport').disabled = false;
        }

        // Close import confirmation modal
        function closeImportConfirmModal() {
            document.getElementById('importConfirmModal').classList.add('hidden');
            pendingImportFile = null;
            document.getElementById('importFileInput').value = '';
        }

        // Confirm and proceed with import
        async function confirmImport() {
            if (!pendingImportFile) {
                showToast('Please select a file first', 'warning');
                return;
            }

            // Store file reference before closing modal (which clears pendingImportFile)
            const fileToUpload = pendingImportFile;

            // Close confirmation modal
            closeImportConfirmModal();

            // Show progress overlay
            showImportProgress();

            try {
                const formData = new FormData();
                formData.append('file', fileToUpload, fileToUpload.name);

                const response = await fetch('/Settings?handler=Import', {
                    method: 'POST',
                    body: formData
                    // Don't set Content-Type header - let browser set it with boundary
                });

                if (response.ok) {
                    const result = await response.json();
                    
                    // Reload the page content without flashing
                    await reloadModelsTable();
                    
                    // Hide progress overlay after content is loaded
                    hideImportProgress();
                    
                    // Show success message after reload completes
                    showToast(result.message || 'Import successful!', 'success');
                } else {
                    hideImportProgress();
                    const error = await response.json().catch(() => ({ error: 'Unknown error' }));
                    showToast('Import failed: ' + (error.error || 'Unknown error'), 'error');
                }
            } catch (error) {
                hideImportProgress();
                showToast('Import failed: ' + error.message, 'error');
            }
        }

        // Reload the models table content without full page refresh
        async function reloadModelsTable() {
            try {
                // Fetch fresh HTML content from the server
                const response = await fetch(window.location.href, {
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest' // Indicate AJAX request
                    }
                });
                
                if (!response.ok) {
                    throw new Error('Failed to reload content');
                }
                
                const html = await response.text();
                
                // Parse the response HTML
                const parser = new DOMParser();
                const doc = parser.parseFromString(html, 'text/html');
                
                // Find the models table container in the new content
                const newTableContainer = doc.querySelector('.models-table-container, .empty-state');
                const currentTableContainer = document.querySelector('.models-table-container')?.parentElement || 
                                            document.querySelector('.empty-state')?.parentElement;
                
                if (newTableContainer && currentTableContainer) {
                    // Smoothly fade out old content
                    currentTableContainer.style.transition = 'opacity 0.2s ease';
                    currentTableContainer.style.opacity = '0';
                    
                    // Wait for fade out
                    await new Promise(resolve => setTimeout(resolve, 200));
                    
                    // Replace the content
                    const newContent = doc.querySelector('.models-table-container, .empty-state');
                    if (newContent) {
                        const oldContent = document.querySelector('.models-table-container, .empty-state');
                        if (oldContent) {
                            oldContent.replaceWith(newContent);
                        }
                    }
                    
                    // Fade in new content
                    currentTableContainer.style.opacity = '1';
                } else {
                    // Fallback to full page reload if we can't find the elements
                    console.warn('Could not find table elements, falling back to full reload');
                    window.location.reload();
                }
            } catch (error) {
                console.error('Error reloading table:', error);
                // Fallback to full page reload on error
                window.location.reload();
            }
        }

        // Show import progress overlay
        function showImportProgress() {
            document.getElementById('importProgressOverlay').classList.remove('hidden');
        }

        // Hide import progress overlay
        function hideImportProgress() {
            document.getElementById('importProgressOverlay').classList.add('hidden');
        }

        // Toast notification system
        function showToast(message, type = 'info') {
            // Create toast container if it doesn't exist
            let container = document.getElementById('toastContainer');
            if (!container) {
                container = document.createElement('div');
                container.id = 'toastContainer';
                container.className = 'toast-container';
                document.body.appendChild(container);
            }

            // Create toast element
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            toast.textContent = message;
            
            container.appendChild(toast);

            // Auto-remove after 4 seconds
            setTimeout(() => {
                toast.classList.add('toast-fade-out');
                setTimeout(() => toast.remove(), 300);
            }, 4000);
        }

        // Close flyout on escape key
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeModelFlyout();
            }
        });

        // Close flyout on background click
        document.getElementById('modelFlyout').addEventListener('click', function(e) {
            if (e.target === this) {
                closeModelFlyout();
            }
        });
</script>
}